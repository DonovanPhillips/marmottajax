var marmottajax=function(){var t=function(t,e){for(var s=t.length;s--;)if(t[s]===e)return!0;return!1},e=function(t,e){for(var s in e)t[s]=e[s]},s=function(t,e){var i,h=[];for(i in t)if(t.hasOwnProperty(i)){var a=t[i],r="object"==typeof a,n=e?e+"["+(isNaN(+i)||r?i:"")+"]":i;h.push(r?s(a,n):encodeURIComponent(n)+"="+encodeURIComponent(a))}return h.join("&")},i=function(){if(this.self)return new i(i.normalize(arguments));var t=i.normalize(arguments);if(null===t)throw"Invalid arguments";e(this,t),"GET"!=this.method.toUpperCase()?this.postData=s(this.parameters):this.url+=("?"==this.url.slice(-1)?"":"?")+s(this.parameters),this.setXhr(),this.setWatcher()};return i.defaultData={method:"get",json:!1,watch:-1,parameters:{}},i.validMethods=["get","post","put","update","delete"],i.okStatusCodes=[200,201,202,203,204,205,206],i.normalize=function(t){if(0===t.length)return null;var e={};return 1===t.length&&"object"==typeof t[0]?e=t[0]:1===t.length&&"string"==typeof t[0]?e={url:t[0]}:2===t.length&&"string"==typeof t[0]&&"object"==typeof t[1]&&(t[1].url=t[0],e=t[1]),"string"!=typeof e.method||-1==i.validMethods.indexOf(e.method.toLowerCase())?e.method=i.defaultData.method:e.method=e.method.toLowerCase(),"boolean"!=typeof e.json&&(e.json=i.defaultData.json),"number"!=typeof e.watch&&(e.watch=i.defaultData.watch),"object"!=typeof e.parameters&&(e.parameters=i.defaultData.parameters),"object"!=typeof e.headers&&(e.headers=i.defaultData.headers),e},i.prototype.setWatcher=function(){-1!==this.watch&&(this.watchIntervalFunction=function(){4===this.xhr.readyState&&t(i.okStatusCodes,this.xhr.status)&&this.updateXhr(),this.watcherTimeout()},this.watcherTimeout(),this.stop=function(){this.changeTime(-1)},this.changeTime=function(t){clearTimeout(this.changeTimeout),this.watch="number"==typeof t?t:this.watch,this.watcherTimeout()})},i.prototype.setXhr=function(){this.xhr=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),this.xhr.lastResult=null,this.xhr.json=this.json,this.xhr.binding=null,this.bind=function(t){return this.xhr.binding=t,this},this.cancel=function(t){return this.xhr.abort(),this},this.xhr.callbacks={then:[],change:[],error:[]};for(var e in this.xhr.callbacks)this.xhr.callbacks.hasOwnProperty(e)&&(this[e]=function(t){return function(e){return this.xhr.callbacks[t].push(e),this}}(e));if(this.xhr.call=function(t,e){for(var s=0;s<this.callbacks[t].length;s++)"function"==typeof this.callbacks[t][s]&&(this.binding?this.callbacks[t][s].call(this.binding,e):this.callbacks[t][s](e))},this.xhr.onreadystatechange=function(){if(4===this.readyState&&t(i.okStatusCodes,this.status)){var e=this.responseText;if(this.json)try{e=JSON.parse(e)}catch(s){return this.call("error","invalid json"),!1}this.lastResult=e,this.call("then",e)}else 4===this.readyState&&404==this.status?this.call("error","404"):4===this.readyState&&this.call("error","unknow")},this.xhr.open(this.method,this.url,!0),this.xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),this.headers)for(header in this.headers)this.headers.hasOwnProperty(header)&&this.xhr.setRequestHeader(header,this.headers[header]);this.xhr.send("undefined"!=typeof this.postData?this.postData:null)},i.prototype.updateXhr=function(){var e={lastResult:this.xhr.lastResult,json:this.xhr.json,binding:this.xhr.binding,callbacks:{then:this.xhr.callbacks.then,change:this.xhr.callbacks.change,error:this.xhr.callbacks.error}};this.xhr=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),this.xhr.lastResult=e.lastResult,this.xhr.json=e.json,this.xhr.binding=e.binding,this.xhr.callbacks={then:e.callbacks.then,change:e.callbacks.change,error:e.callbacks.error},this.xhr.call=function(t,e){for(var s=0;s<this.callbacks[t].length;s++)"function"==typeof this.callbacks[t][s]&&(this.binding?this.callbacks[t][s].call(this.binding,e):this.callbacks[t][s](e))},this.xhr.onreadystatechange=function(){if(4===this.readyState&&t(i.okStatusCodes,this.status)){var e=this.responseText;if(this.json)try{e=JSON.parse(e)}catch(s){return this.call("error","invalid json"),!1}isDifferent=this.lastResult!=e;try{isDifferent=("string"!=typeof this.lastResult?JSON.stringify(this.lastResult):this.lastResult)!=("string"!=typeof e?JSON.stringify(e):e)}catch(s){}isDifferent&&this.call("change",e),this.lastResult=e}else 4===this.readyState&&404==this.status?this.call("error","404"):4===this.readyState&&this.call("error","unknow")},this.xhr.open(this.method,this.url,!0),this.xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),this.xhr.send("undefined"!=typeof postData?postData:null)},i.prototype.watcherTimeout=function(){-1!==this.watch&&(this.changeTimeout=setTimeout(function(t){return function(){t.watchIntervalFunction()}}(this),this.watch))},i}();